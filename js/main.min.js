var gl;var canvas;var buffer;var loc=[0,0];var size;var zoom=0;var program;var clicking=false,pLoc;var julia=true,juliaTracking=false;var uniformCache={};var mLoc=[0,0];var mPos=[0,0];var iterShown=false;var waveShown=false;var shaderScript;var shaderSource;var vertexShader;var fragmentShader;var elements={};var uniformCount=0;var uniformElements=[];var binaryColors=[[255,255,255],[0,0,0]];var savedImages=0;var fractalCount=1;var texture;var textureArray=new Uint8Array(256*4);var fractalParams;var orbitTexture=0;var orbitImage=false;var orbitImageSize=.5;var uniforms={};var onserver=true;var pallets=[{name:"B & W",pallet:[{color:{r:255,g:255,b:255},position:0},{color:{r:0,g:0,b:0},position:1}]},{name:"Dijital Elefan",pallet:[{color:{r:43,g:35,b:0},position:0},{color:{r:95,g:158,b:162},position:1}]},{name:"Rainbow",pallet:[{color:{r:241,g:2,b:0},position:0},{color:{r:254,g:254,b:0},position:.17142857142857143},{color:{r:12,g:251,b:4},position:.36428571428571427},{color:{r:3,g:247,b:251},position:.5928571428571429},{color:{r:235,g:0,b:243},position:.8},{color:{r:248,g:2,b:6},position:1}]},{name:"Strawberries",pallet:[{color:{r:246,g:1,b:64},position:0},{color:{r:252,g:254,b:146},position:1}]},{name:"Sorbet",pallet:[{color:{r:14,g:88,b:96},position:0},{color:{r:250,g:128,b:120},position:1}]},{name:"Sunset",pallet:[{color:{r:7,g:9,b:53},position:0},{color:{r:21,g:15,b:121},position:.2357142857142857},{color:{r:202,g:20,b:92},position:.4857142857142857},{color:{r:232,g:6,b:33},position:.75},{color:{r:234,g:115,b:26},position:.8714285714285714},{color:{r:226,g:185,b:2},position:1}]},{name:"Cotton Candy",pallet:[{color:{r:131,g:175,b:155},position:0},{color:{r:200,g:200,b:169},position:.3},{color:{r:249,g:205,b:173},position:.4},{color:{r:252,g:157,b:154},position:.5},{color:{r:254,g:67,b:101},position:1}]},{name:"Vintage",pallet:[{color:{r:236,g:208,b:120},position:0},{color:{r:217,g:91,b:67},position:.25},{color:{r:192,g:41,b:66},position:.5},{color:{r:84,g:36,b:55},position:.75},{color:{r:13,g:119,b:122},position:1}]},{name:"Orchid",pallet:[{color:{r:82,g:42,b:66},position:0},{color:{r:190,g:119,b:103},position:.25},{color:{r:234,g:188,b:152},position:.5},{color:{r:239,g:77,b:66},position:1}]}];var shaderDetails={globals:"       #ifdef GL_FRAGMENT_PRECISION_HIGH\n"+"               precision highp float;\n"+"       #else\n"+"               precision mediump float;\n"+"       #endif\n"+"       #define TWO_PI 6.28318530718\n"+"       #define PI 3.14159265359\n"+"       #define INVERSE_TWOPI 0.15915494309\n"+"       \n"+"       uniform float u_zoom;\n"+"       uniform vec2  u_loc;\n"+"       uniform vec2  u_size;\n"+"       uniform vec4  u_fgColor;\n"+"       uniform vec4  u_bgColor;\n",waveGlobals:"       uniform float u_wave_phase;\n"+"       uniform float u_wave_count;\n",juliaGlobal:"       uniform vec2  u_c;\n",customUniforms:["       uniform float ",";\n"],iterSkip:["       const int     c_iterSkip=",";\n"],iterations:["       const int     c_iterations=",";\n"],antialiasingConstant:["       const int     c_antialiasing=",";\n"],escape:["       const float   c_escape=",";\n"],sq:"       float sq(float f){\n"+"               return f*f;\n"+"       }\n",normalEscape:"       bool escapes(vec2 z){\n"+"               return length(z)>c_escape;\n"+"       }\n",diamondEscape:"       //hi\n"+"       bool escapes(vec2 z){\n"+"               return abs(z.x)+abs(z.y)>c_escape*c_escape;\n"+"       }\n",squareEscape:"       bool escapes(vec2 z){\n"+"               float sqEscape=c_escape*c_escape;\n"+"               return abs(z.x)>sqEscape || abs(z.y)>sqEscape;\n"+"       }\n",colors:["       vec4 bgColor = vec4(",",1.0);\n"+"       vec4 fgColor = vec4(",",1.0);\n"],binaryColorSimple:"       vec4 getColor(float c){\n"+"               return mix(bgColor, fgColor, clamp(c,0.0,1.0));\n"+"       }\n",binaryColorCycle:"       vec4 getColor(float c){\n"+"               c = (mod(c, 2.0) < 1.0) ? mod(c, 1.0): 1.0 - mod(c, 1.0);\n"+"               return mix(bgColor, fgColor, clamp(c,0.0,1.0));\n"+"       }\n",textureColorSimple:"       uniform sampler2D u_tex;\n"+"       vec4 getColor(float c){\n"+"               return texture2D(u_tex, vec2(clamp(c, 0.0, 1.0), 0.5));\n"+"       }\n",textureColorCycle:"       uniform sampler2D u_tex;\n"+"       vec4 getColor(float c){\n"+"               c = (mod(c, 2.0) < 1.0) ? mod(c, 1.0): 1.0 - mod(c, 1.0);\n"+"               //return mix(vec4(0.0,0.0,0.0,1.0), vec4(1.0,1.0,1.0,1.0), 1.0-clamp(c,0.01,0.99));\n"+"               return texture2D(u_tex, vec2(clamp(c, 0.01, 0.99), 0.5));\n"+"       }\n",orbitTrapData:["      uniform sampler2D u_orbitText;\n"+"      const float c_orbitAspect = ",";\n"+"      uniform float u_orbitSize;\n"],probing:["       float getDepth(vec2 z){\n","                      if(escapes(z)){\n"+"                               return (float(i)-log2(log2(length(z))))*.03;\n"+"                               break;\n"+"                      }\n"+"               }\n"+"               return (float(c_iterations)-log2(log2(length(z))))*.03;\n"+"       }\n"],getColor:["       vec4 getColor(vec2 z){\n"+"               vec4 col = getColor(1.0);\n"+"               float ztx;\n","               return col;\n"+"       }\n"],normal:"       void main() {\n"+"               vec2 z=vec2(gl_FragCoord.x,gl_FragCoord.y);\n"+"               z.x=(z.x-u_size.x/2.0)*u_zoom+u_loc.x;\n"+"               z.y=(z.y-u_size.y/2.0)*u_zoom+u_loc.y;\n"+"               gl_FragColor = getColor(z);\n"+"       }\n",antialiasingSimple:"       void main() {\n"+"               vec2 pixelLocation=vec2(gl_FragCoord.x,gl_FragCoord.y);\n"+"               float blockSize=1.0/float(c_antialiasing+1);\n"+"               float offset=-0.5+blockSize;\n"+"               vec2 z=vec2(0,0);\n"+"               vec4 c=vec4(0.0);\n"+"               for(int x=0;x<c_antialiasing;x++){\n"+"                     for(int y=0;y<c_antialiasing;y++){\n"+"                               z.x=pixelLocation.x+float(x)*blockSize+offset;\n"+"                               z.y=pixelLocation.y+float(y)*blockSize+offset;\n"+"                               z.x=(z.x-u_size.x/2.0)*u_zoom+u_loc.x;\n"+"                               z.y=(z.y-u_size.y/2.0)*u_zoom+u_loc.y;\n"+"                               c+=getColor(z);\n"+"                     }\n"+"               }\n"+"               gl_FragColor = c/float(c_antialiasing*c_antialiasing);\n"+"       }\n",antialiasingRandom:"       float rand(float a, float b){\n"+"               return fract(sin(a*12.9898+b*78.233)* 43758.5453);\n"+"       }\n"+"       void main() {\n"+"               vec2 pixelLocation=vec2(gl_FragCoord.x,gl_FragCoord.y);\n"+"               float blockSize=1.0/float(c_antialiasing+1);\n"+"               float offset=-0.5+blockSize;\n"+"               vec2 z=vec2(0,0);\n"+"               vec4 c=vec4(0.0);\n"+"               for(int i=0;i<c_antialiasing;i++){\n"+"                      z=vec2(rand(float(i),1.2),rand(float(i), 3.8))+pixelLocation;\n"+"                      z.x=(z.x-u_size.x/2.0)*u_zoom+u_loc.x;\n"+"                      z.y=(z.y-u_size.y/2.0)*u_zoom+u_loc.y;\n"+"                      c+=getColor(z);\n"+"               }\n"+"               gl_FragColor = c/float(c_antialiasing);\n"+"       }\n",initialize:"               float ztx;\n",initializeFloats:["               float ",";\n"],initializeVects:["               vec2 ",";\n"],juliaConst:"               vec2 c = u_c;\n",normalConst:"               vec2 c = z;\n",loop:"               for(int i=0;i<c_iterations;i++){\n",tmp:"                       ztx=z.x;\n",end:"       }\n",maths:"        vec2 complexAbs(vec2 a){\n"+"            return vec2(abs(a.x), abs(a.y));\n"+"        }\n"+"        vec2 complexIAbs(vec2 a){\n"+"            return vec2(a.x, abs(a.y));\n"+"        }\n"+"        vec2 complexRAbs(vec2 a){\n"+"            return vec2(abs(a.x), a.y);\n"+"        }\n"+"        vec2 complexInvert(vec2 a){\n"+"            float r=dot(a,a);\n"+"            return vec2(a.x/r, -a.y/r);\n"+"        }\n"+"        vec2 complexConj(vec2 a){\n"+"            return vec2(a.x, -a.y);\n"+"        }\n"+"        vec2 complexMult(vec2 a, vec2 b){\n"+"            return vec2(a.x*b.x-a.y*b.y, a.x*b.y+a.y*b.x);\n"+"        }\n"+"        vec2 complexDiv(vec2 a, vec2 b){\n"+"            return complexMult(a, complexConj(b))/dot(b,b);\n"+"        }\n"+"        vec2 complexLog(vec2 a){\n"+"            return vec2(log(length(a)), atan(a.y, a.x));\n"+"        }\n"+"        vec2 complexSq(vec2 a){\n"+"            return vec2(a.x*a.x-a.y*a.y, 2.0*a.x*a.y);\n"+"        }\n"+"        vec2 complexPow(vec2 a, float b){\n"+"            float r=pow(length(a), b);\n"+"            float theta=atan(a.y, a.x)*b;\n"+"            return vec2(r*cos(theta), r*sin(theta));\n"+"        }\n"+"        vec2 complexSqrt(vec2 a){\n"+"            float r=length(a);\n"+"            return vec2(0.70710678118*sqrt(r+a.x), 0.70710678118*sqrt(r-a.y)*sign(a.y));\n"+"        }\n"+"        float cosh(float a){\n"+"            return (exp(a)+exp(-a))/2.0;\n"+"        }\n"+"        float sinh(float a){\n"+"            return (exp(a)-exp(-a))/2.0;\n"+"        }\n"+"        vec2 complexSin(vec2 a){\n"+"            return vec2(sin(a.x)*cosh(a.y), cos(a.x)*sinh(a.y));\n"+"        }\n"+"        vec2 complexCos(vec2 a){\n"+"            return vec2(cos(a.x)*cosh(a.y), sin(a.x)*sinh(a.y));\n"+"        }\n"+"        vec2 complexCube(vec2 a){\n"+"            return complexMult(complexSq(a), a);\n"+"        }\n"+"        vec2 complex4(vec2 a){\n"+"            return complexSq(complexSq(a));\n"+"        }\n"+"        vec2 complexExp(vec2 a){\n"+"            float r=exp(a.x);\n"+"            return vec2(r*cos(a.y), r*sin(a.y));\n"+"}\n",fractals:{mandelbrot:"                       z.x = z.x*z.x - z.y*z.y + c.x;\n"+"                       z.y = 2.0*ztx*z.y + c.y;\n",burningShip:"                       z.x = z.x*z.x - z.y*z.y + c.x;\n"+"                       z.y = abs(2.0*ztx*z.y) + c.y;\n",rootedShip:"                       z.x = z.x*z.x - z.y*z.y + c.x;\n"+"                       z.y = 2.0*sqrt(abs(ztx*z.y)) + c.y;\n",splatter:"                       z.x = z.x*z.x - z.y*z.y + c.x;\n"+"                       z.y = 2.0*(ztx*z.y/(c.x/c.y)) + c.y;\n",sineX:"                       z.x = sin(z.x);\n",sineY:"                       z.y = sin(z.y);\n",sineXY:"                       z.x = sin(z.y);\n"+"                       z.y = sin(ztx);\n",arrowhead:"                       z.x = z.x*z.x - z.y*z.y + z.x*c.x;\n"+"                       z.y = 2.0*ztx*z.y + z.y*c.y;\n",ducks:"                       z.x = log(length(z));\n"+"                       z.y = atan(abs(z.y), ztx);\n"+"                       z   += c;\n",duckMod:"                       z.x += c.x;\n"+"                       z.y = abs(z.y) + c.y;\n"+"                       ztx = log(length(z));\n"+"                       z.y = atan(z.y, z.x);\n"+"                       z.x = ztx;\n",petals:"                       f1=z.x*z.x;\n"+"                       f2=z.y*z.y;\n"+"                       f3=f1-f2+c.x-1.0;\n"+"                       f4=2.0*z.x*z.y+c.y;\n"+"                       f5=f3*f3 - f4*f4;\n"+"                       f6=2.0*f3*f4;\n"+"                       f7=2.0*z.x+c.x-2.0;\n"+"                       f8=2.0*z.y+c.y;\n"+"                       f9=f7*f7-f8*f8;\n"+"                       f10=2.0*f7*f8;\n"+"                       f11=f9*f9-f10*f10;\n"+"                       z.x=(f5*f9+f6*f10)/f11;\n"+"                       z.y=(f5*f10+f9*f6)/f11;\n",tree:"                       z.x=abs(z.x*z.x-z.y*z.y)+c.x;\n"+"                       z.y=2.0*(ztx*z.y)+c.y;\n",target:"                       f1=(z.x*z.x+z.y*z.y);\n"+"                       z.x=z.x/2.0-z.x/f1+c.x;\n"+"                       z.y=z.y/2.0-z.y/f1+c.y;\n",crosshair:"                       z.x=z.x/3.0-1.0/(z.x*z.x+z.y*z.y)+c.x;\n"+"                       z.y=z.y/3.0-1.0/(2.0*ztx*z.y)+c.y;\n",log:"                       f1=z.x*z.x;\n"+"                       f2=z.y*z.y;\n"+"                       f3=f1-f2+c.x-1.0;\n"+"                       f4=2.0*z.x*z.y+c.y;\n"+"                       f5=f3*f3 - f4*f4;\n"+"                       f6=2.0*f3*f4;\n"+"                       f7=2.0*z.x+c.x-2.0;\n"+"                       f8=2.0*z.y+c.y;\n"+"                       f9=f7*f7-f8*f8;\n"+"                       f10=2.0*f7*f8;\n"+"                       f11=f9*f9-f10*f10;\n"+"                       z.x=abs(f5*f9+f6*f10)/f11;\n"+"                       z.y=-abs(f5*f10+f9*f6)/f11;\n",tricorn:"                       v1=vec2(z.x*z.x,z.y*z.y);\n"+"                       f1=sq(v1.x-v1.y)+4.0*v1.x*v1.y;\n"+"                       z.x=(v1.x-v1.y)/f1+c.x;\n"+"                       z.y=z.x*ztx*z.y/f1+c.y;\n",woo:"                       z.x=z.x*z.x-z.y*z.y+c.x;\n"+"                       z.y=-2.0*(ztx*z.y)+c.y;\n",invertedMandelbrot:"                       v1=vec2(z.x*z.x,z.y*z.y);\n"+"                       f1=sq(v1.x+v1.y);\n"+"                       z.x=(v1.x-v1.y)/f1+c.x;\n"+"                       z.y=c.y-2.0*ztx*z.y/f1;\n",woo2:"                       v1=vec2(z.x*z.x,z.y*z.y);\n"+"                       f1=sq(v1.x+v1.y);\n"+"                       z.x=(v1.x-v1.y)/f1+c.x;\n"+"                       z.y=2.0*ztx*z.y/f1+c.y;\n",power:"                       f1 = pow(length(z), u_power);\n"+"                       f2 = atan(z.y, z.x)*u_power;\n"+"                       z.x = f1*cos(f2)+c.x;\n"+"                       z.y = f1*sin(f2)+c.y;\n",magnet:"                       f1=z.x*z.x-z.y*z.y+c.x-1.0;\n"+"                       f2=2.0*z.x*z.y+c.y;\n"+"                       f3=2.0*z.x+c.x-2.0;\n"+"                       f4=2.0*z.y+c.y;\n"+"                       f7=(f3*f3+f4*f4);\n"+"                       f5=(f1*f3+f2*f4)/f7;\n"+"                       f6=(f1*f4+f3*f2)/f7;\n"+"                       z.x=f5*f5-f6*f6;\n"+"                       z.y=2.0*f5*f6;\n",mandelbox:"                       z=vec2(abs(z.x)*c_escape+c.x, abs(z.y)*c_escape+c.y);\n"+"                       f1=z.x*z.x+z.y*z.y;\n"+"                       if (f1>c_escape) {\n"+"                               z.x=z.x/c_escape;\n"+"                               z.y=z.y/c_escape;\n"+"                       }\n"+"                       else if (f1<1.0) {\n"+"                               z.x=z.x/f1;\n"+"                               z.y=z.y/f1;\n"+"                       }\n",kalliset:"                       f1=z.x*z.x+z.y*z.y;\n"+"                       z.x=abs(z.x)/f1+c.y;\n"+"                       z.y=abs(z.y)/f1+c.x;\n",kallibox:"                       f1=z.x*z.y;\n"+"                       z.x=abs(z.x)/f1+c.x;\n"+"                       z.y=abs(z.y)/f1+c.y;\n",kalli1:"                       z=complexAbs(complexInvert(z))+ c;\n",kalli2:"                       z=complexLog(complexAbs(complexInvert(z))+c);\n",kalli3:"                       z=complexInvert(complexAbs(z))+ c;\n",kalli4:"                       z=complexDiv(complexAbs(c), complexAbs(z))+c;\n",kalli5:"                       v1=complexAbs(complexMult(z, c)+ vec2(1.0,0.0));\n"+"                       z=v1+complexInvert(v1);\n",trigonometricKalli:"                       z=complexSin(complexAbs(complexInvert(z))+ c);\n",torus1:"                       z = mod(z, 2.0);\n"+"                       if(z.x < 0.0){z.x+=2.0;}\n"+"                       if(z.y < 0.0){z.y+=2.0;}\n",torus:"                       if(z.x < -1.0 ){\n"+"                               f1 = mod(-z.x-1.0, 4.0);\n"+"                               if(f1 < 2.0){ z.x=1.0-f1; }\n"+"                               else        { z.x=f1-3.0; }\n"+"                       }else if(z.x > 1.0){\n"+"                               f1 = mod(z.x-1.0, 4.0);\n"+"                               if(f1 < 2.0){ z.x=f1-1.0; }\n"+"                               else        { z.x=3.0-f1; }\n"+"                       }\n"+"                       if(z.y < -1.0 ){\n"+"                               f1 = mod(-z.y-1.0, 4.0);\n"+"                               if(f1 < 2.0){ z.y=1.0-f1; }\n"+"                               else        { z.y=f1-3.0; }\n"+"                       }else if(z.y > 1.0){\n"+"                               f1 = mod(z.y-1.0, 4.0);\n"+"                               if(f1 < 2.0){ z.y=f1-1.0; }\n"+"                               else        { z.y=3.0-f1; }\n"+"                       }\n",invertedBurningShip:"                           z=complexIAbs(complexInvert(complexSq(z)))+c;\n",powerBurningShip:"                           z=complexIAbs(complexInvert(complexPow(z, -u_power)))+c;\n",invertedTrees:"                           z=complexRAbs(complexInvert(complexSq(z)))+c;\n",powerTrees:"                           z=complexRAbs(complexInvert(complexPow(z, -u_power)))+c;\n"},renderers:{binary:"                       if(escapes(z)){\n"+"                               col =  getColor(0.0);\n"+"                               break;\n"+"                       }\n"+"               }\n",binaryCheckerboard:"                       if(escapes(z)){\n"+"                               if(z.x>0.0 ^^ z.y>0.0){\n"+"                                       col = getColor(0.0);\n"+"                               }\n"+"                               break;\n"+"                       }\n"+"               }\n",linear:"                       if(escapes(z)){\n"+"                               return getColor(float(i)/float(c_iterations));\n"+"                               break;\n"+"                       }\n"+"               }\n",linearCheckerboard:"                       if(escapes(z)){\n"+"                               float c=float(i)/float(c_iterations);\n"+"                               if(z.x>0.0 ^^ z.y > 0.0){\n"+"                                       c=1.0-c;\n"+"                               }\n"+"                               return getColor(c);\n"+"                               break;\n"+"                       }\n"+"               }\n",simpleSinusoid:"                       if(escapes(z)){\n"+"                               return getColor(sin(float(i)/float(c_iterations)*TWO_PI*u_wave_count+u_wave_phase));\n"+"                            break;\n"+"                   }\n"+"               }\n",simpleSinusoidCheckerboard:"                       if(escapes(z)){\n"+"                               float c=sin(float(i)/float(c_iterations)*TWO_PI*u_wave_count+u_wave_phase);\n"+"                               if(z.x>0.0 ^^ z.y > 0.0){\n"+"                                       c=1.0-c;\n"+"                               }\n"+"                               return getColor(c);\n"+"                   }\n"+"               }\n",logarithmicSmoothing:"                      if(escapes(z)){\n"+"                               return getColor((float(i)-log2(log2(length(z))))*.03);\n"+"                      }\n"+"               }\n",smoothCheckerboard:"                      if(escapes(z)){\n"+"                               float c=((float(i)-log2(log2(length(z))))*.03);\n"+"                               if(z.x>0.0 ^^ z.y > 0.0){\n"+"                                       c=1.0-c;\n"+"                               }\n"+"                               return getColor(c);\n"+"                      }\n"+"               }\n",logarithmicRidging:"                      if(escapes(z)){\n"+"                               return getColor((float(i)-log2(log2(length(z))))*.6/float(i));\n"+"                     }\n"+"               }\n",smoothSinusoid:"                      if(escapes(z)){\n"+"                               return getColor(sin(((float(i)-log2(log2(length(z))))*.03)*TWO_PI*u_wave_count+u_wave_phase));\n"+"                      }\n"+"               }\n",dynamicSystem:"                       if(i > 10 && mod(float(i), float(c_iterSkip)) == 0.0){\n"+"                               rf1+=dot(z,z);\n"+"                               rf2+=1.0;\n"+"                       }\n"+"               }\n"+"               col = getColor(sqrt(rf1/rf2));\n",angleSystem:"                       if(mod(float(i), float(c_iterSkip)) == 0.0){\n"+"                               rv1+=z;\n"+"                               rf1+=1.0;\n"+"                       }\n"+"               }\n"+"               rv1/=rf1;\n"+"               col = getColor((atan(rv1.x, rv1.y)+PI)*INVERSE_TWOPI);\n",smoothAngleSystem:"                       if(mod(float(i), float(c_iterSkip)) == 0.0){\n"+"                               rv1+=z;\n"+"                               rf1+=1.0;\n"+"                       }\n"+"               }\n"+"               rv1/=rf1;\n"+"               col = getColor(abs(atan(rv1.x, rv1.y))*INVERSE_TWOPI*2.0);\n",magnitudeSystem:"                       if(mod(float(i), float(c_iterSkip)) == 0.0){\n"+"                               rv1+=z;\n"+"                               rf1+=1.0;\n"+"                       }\n"+"               }\n"+"               rv1/=rf1;\n"+"               col = getColor((rv1.x*rv1.x+rv1.y*rv1.y)/(c_escape*c_escape));\n",fauxD:"               float l = .1 * u_zoom;\n"+"               vec2 delta=vec2(l*cos(u_theta), l*sin(u_theta));\n"+"               col = getColor((getDepth(z)-getDepth(z+delta))*u_magnitude);\n",pointOrbit:"                       rf2 = dot(z,z);\n"+"                       if(i < 2 || rf2 < rf1){\n"+"                               rf1 = rf2;\n"+"                       }\n"+"               }\n"+"               rf1=sqrt(rf1);\n"+"               col = getColor(rf1);\n",crossOrbit:"                       rf2 = min(abs(z.x), abs(z.y));\n"+"                       if(i < 2 || rf2 < rf1){\n"+"                               rf1 = rf2;\n"+"                       }\n"+"               }\n"+"               rf1=sqrt(rf1);\n"+"               col = getColor(rf1);\n",crossPoint:"                       rf2 = min(abs(z.x), abs(z.y))+dot(z,z);\n"+"                       if(i < 2 || rf2 < rf1){\n"+"                               rf1 = rf2;\n"+"                       }\n"+"               }\n"+"               rf1=sqrt(rf1);\n"+"               col = getColor(rf1);\n",circleOrbit:"                       rf2 = abs(dot(z,z) - .5);\n"+"                       if(i < 2 || rf2 < rf1){\n"+"                               rf1 = rf2;\n"+"                       }\n"+"               }\n"+"               rf1=sqrt(rf1);\n"+"               col = getColor(rf1);\n",diamondOrbit:"                       rf2 = abs(abs(z.x)+abs(z.y) - .5);\n"+"                       if(i < 2 || rf2 < rf1){\n"+"                               rf1 = rf2;\n"+"                       }\n"+"               }\n"+"               rf1=sqrt(rf1);\n"+"               col = getColor(rf1);\n",orbitImage:"                       if(abs(z.x) < u_orbitSize*c_orbitAspect && abs(z.y) < u_orbitSize){\n"+"                               rf1 = u_orbitSize*c_orbitAspect;\n"+"                               col = texture2D(u_orbitText, vec2((z.x+rf1)/(2.0*rf1),\n"+"                                                                 (u_orbitSize-z.y)/(2.0*u_orbitSize)));\n"+"                               break;\n"+"                       }\n"+"               }\n",orbitImageCut:"                       if(abs(z.x) < u_orbitSize*c_orbitAspect && abs(z.y) < u_orbitSize){\n"+"                               rf1 = u_orbitSize*c_orbitAspect;\n"+"                               vec4 tmp = texture2D(u_orbitText, vec2((z.x+rf1)/(2.0*rf1),\n"+"                                                                 (u_orbitSize-z.y)/(2.0*u_orbitSize)));\n"+"                               if(2.95 > tmp.r+tmp.g+tmp.b){\n"+"                                       if(tmp.a == 1.0){\n"+"                                               col = tmp;\n"+"                                               break;\n"+"                                       }else{\n"+"                                               col = mix(col, tmp, tmp.a);\n"+"                                       }\n"+"                               }\n"+"                       }\n"+"               }\n",orbitImageColors:"                       if(abs(z.x) < u_orbitSize*c_orbitAspect && abs(z.y) < u_orbitSize){\n"+"                               rf1 = u_orbitSize*c_orbitAspect;\n"+"                               vec4 tmp = texture2D(u_orbitText, vec2((z.x+rf1)/(2.0*rf1),\n"+"                                                                 (u_orbitSize-z.y)/(2.0*u_orbitSize)));\n"+"                               if( abs(tmp.r - u_bgColor.r) + abs(tmp.g - u_bgColor.g) + abs(tmp.b - u_bgColor.b) > 0.3){\n"+"                                       if(tmp.a == 1.0){\n"+"                                               col = tmp;\n"+"                                               break;\n"+"                                       }else{\n"+"                                               col = mix(col, tmp, tmp.a);\n"+"                                       }\n"+"                               }\n"+"                       }\n"+"               }\n"}};function str(i){return i.toString()}function getFractalScript(params){var eqns=shaderDetails.tmp+shaderDetails.fractals.mandelbrot;var data={uniforms:[]};if("fractal"in params){if(params.fractal in shaderDetails.fractals){if(params.fractals[i].indexOf("power")!=-1)data.uniforms=[{min:-5,max:5,name:"u_power",title:"Power",value:2,step:.5}];eqns=shaderDetails.tmp+shaderDetails.fractals[params.fractal]}else{eqns=shaderDetails.tmp+params.fractal}}if("fractals"in params){eqns="";for(var i=0;i<params.fractals.length;i++){if(params.fractals[i]in shaderDetails.fractals){if(params.fractals[i].indexOf("power")!=-1)data.uniforms=[{min:-5,max:5,name:"u_power",title:"Power",value:2,step:.5}];eqns+=shaderDetails.tmp+shaderDetails.fractals[params.fractals[i]]}else{eqns+=shaderDetails.tmp+params.fractals[i]}}}var fractalScript="";if(eqns.indexOf("f1")!=-1){fractalScript+=shaderDetails.initializeFloats[0];var i=1;var float="f"+i;while(eqns.indexOf(float)!=-1){if(i>1)fractalScript+=", ";fractalScript+=float+"=0.0";i++;float="f"+i}fractalScript+=shaderDetails.initializeFloats[1]}if(eqns.indexOf("v1")!=-1){fractalScript+=shaderDetails.initializeVects[0];var i=1;var vect="v"+i;while(eqns.indexOf(vect)!=-1){if(i>1)fractalScript+=", ";fractalScript+=vect+"=vec2(0.0,0.0)";i++;vect="v"+i}fractalScript+=shaderDetails.initializeVects[1]}if("julia"in params)fractalScript+=shaderDetails.juliaConst;else fractalScript+=shaderDetails.normalConst;fractalScript+=shaderDetails.loop;fractalScript+=eqns;if(eqns.indexOf("complex")!=-1)data.includeMath=true;data.script=fractalScript;return data}function makeShader(params){var julia=false;var iters=100;var renderScript=shaderDetails.renderers.linear;var escape=2;var escapeType=0;var bgColor="1.0, 1.0, 1.0",fgColor="0.0, 0.0, 0.0";var data={iterSkip:0,julia:false,wave:false};var fractalData=getFractalScript(params);var fractalScript=fractalData.script;var includeMath=fractalData.includeMath;var faux=false;var antialiasing={type:0};data.uniforms=fractalData.uniforms;data.colorScheme="texture";if("julia"in params)data.julia=true;if("iterations"in params)iters=params["iterations"];if("escapeType"in params){if(params.escapeType=="normal")escapeType=0;else if(params.escapeType=="square")escapeType=1;else if(params.escapeType=="diamond")escapeType=2}console.log("escape type #:",escapeType);console.log(params.renderer);if("renderer"in params){if(params.renderer in shaderDetails.renderers){if(params.renderer.indexOf("Sinusoid")!=-1)data.wave=true;if(params.renderer.indexOf("System")!=-1)data.iterSkip=1;if(params.renderer=="fauxD"){faux=true;data.uniforms.push({name:"u_magnitude",title:"Magnitude",min:1,max:1e3});data.uniforms.push({name:"u_theta",title:"Theta",min:0,max:6.38})}if(params.renderer.substr(0,0)=="orbitImage"&&!("orbitImage"in params)){console.log("widthifying");params.orbitImage={width:1,height:1}}renderScript=shaderDetails.renderers[params.renderer]}else{if(params.renderer.indexOf("u_wave_count")!=-1)data.wave=true;renderScript=params.renderer}}if("iterSkip"in params&&data.iterSkip==1){data.iterSkip=params.iterSkip}if("antialiasing"in params){antialiasing=params.antialiasing}if(params.binaryColors[0].length==3){bgColor=str(params.binaryColors[0][0]/255)+", "+str(params.binaryColors[0][1]/255)+", "+str(params.binaryColors[0][2]/255)}else{bgColor=params.binaryColors[0]}if(params.binaryColors[1].length==3){fgColor=str(params.binaryColors[1][0]/255)+", "+str(params.binaryColors[1][1]/255)+", "+str(params.binaryColors[1][2]/255)}else{fgColor=params.binaryColors[1]}if("escape"in params){escape=params.escape}var source=shaderDetails.globals;for(u in data.uniforms){source+=shaderDetails.customUniforms[0]+data.uniforms[u].name+shaderDetails.customUniforms[1]}if("orbitImage"in params){var width=params.orbitImage.width/2;var height=params.orbitImage.height/2;source+=shaderDetails.orbitTrapData[0]+(width/height).toFixed(4)+shaderDetails.orbitTrapData[1]}source+=shaderDetails.iterations[0]+iters.toString()+shaderDetails.iterations[1];source+=shaderDetails.escape[0]+escape.toFixed(2)+shaderDetails.escape[1];if(data.colorScheme=="binary"){source+=shaderDetails.binaryColorCycle}else{if(params.colorCycle){source+=shaderDetails.textureColorCycle}else{source+=shaderDetails.textureColorSimple}}if(includeMath)source+=shaderDetails.maths;if(fractalScript.indexOf("sq(")!=-1)source+=shaderDetails.sq;if(antialiasing.type>0)source+=shaderDetails.antialiasingConstant[0]+antialiasing.count+shaderDetails.antialiasingConstant[1];if(data.iterSkip>0)source+=shaderDetails.iterSkip[0]+data.iterSkip+shaderDetails.iterSkip[1];switch(escapeType){case 0:source+=shaderDetails.normalEscape;break;case 1:source+=shaderDetails.squareEscape;break;case 2:source+=shaderDetails.diamondEscape;break}if(data.julia)source+=shaderDetails.juliaGlobal;if(data.wave)source+=shaderDetails.waveGlobals;if(faux){source+=shaderDetails.probing[0];source+=shaderDetails.initialize;source+=fractalScript;source+=shaderDetails.probing[1];source+=shaderDetails.getColor[0];source+=renderScript;source+=shaderDetails.getColor[1]}else{source+=shaderDetails.getColor[0];if(renderScript.indexOf("rf1")!=-1){source+=shaderDetails.initializeFloats[0];var i=1;var float="rf"+i;while(renderScript.indexOf(float)!=-1){if(i>1)source+=", ";source+=float+"=0.0";i++;float="rf"+i}source+=shaderDetails.initializeFloats[1]}if(renderScript.indexOf("rv1")!=-1){source+=shaderDetails.initializeVects[0];var i=1;var vect="rv"+i;while(renderScript.indexOf(vect)!=-1){if(i>1)source+=", ";source+=vect+"=vec2(0.0,0.0)";i++;vect="rv"+i}source+=shaderDetails.initializeVects[1]}source+=fractalScript;source+=renderScript;source+=shaderDetails.getColor[1]}switch(antialiasing.type){case 0:source+=shaderDetails.normal;break;case 1:source+=shaderDetails.antialiasingSimple;break;case 2:source+=shaderDetails.antialiasingRandom;break}data.source=source;return data}function toggleClass(elem,className){if(typeof elem.className=="undefined"){elem.className=""}var index=elem.className.indexOf(className);if(index==-1)elem.className+=" "+className;else elem.className=elem.className.substr(0,index)+elem.className.substr(index+className.length+1)}function setClass(elem,className,toggle){if(typeof elem.className=="undefined"){elem.className=""}var index=elem.className.indexOf(className);if(index==-1&&toggle)elem.className+=" "+className;else if(index>-1&&!toggle)elem.className=elem.className.substr(0,index)+elem.className.substr(index+className.length+1)}function downloadURI(linkElem,uri,name){linkElem.setAttribute("download",name);linkElem.href=uri}function saveImageAndDownload(img){var x=new XMLHttpRequest;x.open("post","",false);var data=new FormData;var imgFile=new Blob([img],{type:"image/png"});data.append("savedImage",imgFile,"largeFractal.png");data.append("api_request","save_and_download");x.send(data);console.log(x.response)}function modalWindow(innerHTML,elem){var modal=document.createElement("DIV");modal.style.position="fixed";modal.style.left="50%";modal.style.top="50%";modal.style.background="rgba(0,0,0,0.7)";modal.style.borderRadius="1em";
modal.style.border="1px solid white";modal.style.color="#fff";modal.style.padding="2em";modal.innerHTML=innerHTML+'<button class="close-button" id="closeModal">close</button>';document.lastChild.lastChild.appendChild(modal);modal.style.marginLeft=-modal.offsetWidth/2+"px";modal.style.marginTop=-modal.offsetHeight/2+"px";document.getElementById("closeModal").addEventListener("click",function(){document.lastChild.lastChild.removeChild(modal)})}function makeAndSubmitForm(url,params,options){if(typeof options==="undefined")options={newTab:false,method:"post"};if(!"newTab"in options)options.newTab=false;if(!"method"in options)options.method="post";var f=document.createElement("form");f.setAttribute("method",method);f.setAttribute("action",url);if(options.newTab)f.setAttribute("target","_blank");for(name in params){var i=document.createElement("input");i.setAttribute("type","text");i.setAttribute("name",name);i.setAttribute("value",params[name]);f.appendChild(i)}var s=document.createElement("input");s.setAttribute("type","submit");s.setAttribute("value","Submit");f.appendChild(s);document.getElementsByTagName("body")[0].appendChild(f);f.submit()}function ajaxFileUpload(url,file,async,options){if(typeof async==="undefined")async=true;options=options||{};var xreq=new XMLHttpRequest;for(key in options){xreq[key]=options[key]}xreq.open("post",url,async);var data=new FormData;data.append("file",file,file.name);xreq.send(data)}function ajax(url,params,type,async,options){if(typeof async==="undefined")async=true;options=options||{};params=params||{};type=type||"post";var xreq=new XMLHttpRequest;for(key in options){xreq[key]=options[key]}xreq.open(type,url,async);if("get"in params&&typeof params.get=="function"){data=params}else{var data=new FormData;for(key in params){data.append(key,params[key])}}xreq.send(data)}function deCamel(s){return s.replace(/([A-Z])/g," $1").replace(/^./,function(str){return str.toUpperCase()})}function randomStringNumbers(length){Math.random().toString(36).substring(0,length)}function getLocation(x,y){return[(x-size[0]/2)*zoom+loc[0],(y-size[1]/2)*zoom+loc[1]]}function moveLoc(loc2,loc1){loc[0]+=loc1[0]-loc2[0];loc[1]+=loc2[1]-loc1[1];setUniform2f(program,"u_loc",loc[0],loc[1]);render()}function initInput(canvas){canvas.addEventListener("mousewheel",function(e){var delta=e.wheelDelta||-e.detail;delta=delta/Math.abs(delta);zoom*=Math.pow(.9,delta);setUniform1f(program,"u_zoom",zoom);render();return false},false);canvas.addEventListener("DOMMouseScroll",function(e){var delta=e.wheelDelta||-e.detail;delta=delta/Math.abs(delta);var oldZoom=zoom;zoom*=Math.pow(.9,delta);setUniform1f(program,"u_zoom",zoom);if(zoom<oldZoom){loc[0]-=(e.clientX-size[0]/2)*(zoom-oldZoom);loc[1]+=(e.clientY-size[1]/2)*(zoom-oldZoom);setUniform2f(program,"u_loc",loc[0],loc[1])}render();return false},false);canvas.addEventListener("mousedown",function(e){clicking=true;pLoc=getLocation(e.clientX,e.clientY)},false);canvas.addEventListener("mousemove",function(e){if(clicking){var tmp=getLocation(e.clientX,e.clientY);moveLoc(tmp,pLoc);pLoc=getLocation(e.clientX,e.clientY)}if(juliaTracking){mLoc=getLocation(e.clientX,e.clientY);elements.juliaX.value=mLoc[0];elements.juliaY.value=mLoc[1];setUniform2f(program,"u_c",mLoc[0],mLoc[1]);render()}},false);canvas.addEventListener("mouseup",function(e){clicking=false},false);canvas.addEventListener("dblclick",function(e){if(julia){juliaTracking=!juliaTracking;document.getElementById("juliaMouse").checked=juliaTracking}},false);window.addEventListener("keypress",function(e){if(e.keyCode==38){if(e.shiftKey){mLoc[1]-=.01;elements.juliaX.value=mLoc[0];elements.juliaY.value=mLoc[1];setUniform2f(program,"u_c",mLoc[0],mLoc[1])}else{zoom*=.8;setUniform1f(program,"u_zoom",zoom)}render()}else if(e.keyCode==40){if(e.shiftKey){mLoc[1]+=.01;elements.juliaX.value=mLoc[0];elements.juliaY.value=mLoc[1];setUniform2f(program,"u_c",mLoc[0],mLoc[1])}else{zoom*=1.25;setUniform1f(program,"u_zoom",zoom)}render()}else if(e.keyCode==37&&e.shiftKey==true){mLoc[0]-=.01;elements.juliaX.value=mLoc[0];elements.juliaY.value=mLoc[1];setUniform2f(program,"u_c",mLoc[0],mLoc[1]);render()}else if(e.keyCode==39&&e.shiftKey==true){mLoc[0]+=.01;elements.juliaX.value=mLoc[0];elements.juliaY.value=mLoc[1];setUniform2f(program,"u_c",mLoc[0],mLoc[1]);render()}else if(e.key=="j"){var julia=document.getElementById("julia");julia.checked=!julia.checked;parseControls()}else if(e.key=="r"){zoom=4/size[1];loc=[0,0];setUniform1f(program,"u_zoom",zoom);setUniform2f(program,"u_loc",loc[0],loc[1]);render()}else if(e.key=="c"){loc=[0,0];setUniform2f(program,"u_loc",loc[0],loc[1]);render()}else if(e.key=="C"){mLoc[0]=0;mLoc[1]=0;elements.juliaX.value=mLoc[0];elements.juliaY.value=mLoc[1];setUniform2f(program,"u_c",mLoc[0],mLoc[1]);render()}return false},false);var recompileElements=document.getElementsByClassName("recompile");for(var i=0;i<recompileElements.length;i++){recompileElements[i].addEventListener("change",parseControls,false)}populateFractallist(document.getElementById("fractal0"));elements.rendererList=document.getElementById("renderer");for(renderer in shaderDetails.renderers){var f=document.createElement("option");f.text=deCamel(renderer);f.value=renderer;elements.rendererList.add(f)}elements.rendererList.value="logarithmicSmoothing";elements.juliaMouse=document.getElementById("juliaMouse");elements.juliaMouse.addEventListener("change",function(e){juliaTracking=e.target.checked});elements.juliaX=document.getElementById("juliaX");elements.juliaY=document.getElementById("juliaY");elements.juliaX.addEventListener("input",function(e){mLoc[0]=elements.juliaX.value;mLoc[1]=elements.juliaY.value;setUniform2f(program,"u_c",elements.juliaX.value,elements.juliaY.value);render()});elements.juliaY.addEventListener("input",function(e){mLoc[0]=elements.juliaX.value;mLoc[1]=elements.juliaY.value;setUniform2f(program,"u_c",elements.juliaX.value,elements.juliaY.value);render()});document.getElementById("download").onclick=function(e){fractalCount++;e.target.setAttribute("download","fractal_"+fractalCount+".png");e.target.href=canvas.toDataURL("image/png")};elements.renderLarge=document.getElementById("renderLarge");if(elements.renderLarge){elements.renderLarge.onclick=function(e){renderLarge(3200,1600,e.target)}}elements.fractalTab=document.getElementById("fractalTab");elements.renderTab=document.getElementById("renderTab");elements.fractalControls=document.getElementById("fractalControls");elements.renderControls=document.getElementById("renderControls");elements.fractalTab.addEventListener("click",function(){setClass(elements.renderTab,"active",false);setClass(elements.fractalControls,"hidden",false);setClass(elements.fractalTab,"active",true);setClass(elements.renderControls,"hidden",true)});elements.renderTab.addEventListener("click",function(){setClass(elements.renderTab,"active",true);setClass(elements.fractalControls,"hidden",true);setClass(elements.fractalTab,"active",false);setClass(elements.renderControls,"hidden",false)});elements.gradientSelector=document.getElementById("gradientSelector");elements.gradientSelector.addEventListener("change",function(e){if(gl){populateColorTexture(e.pallet);setUniform4f(program,"u_fgColor",binaryColors[0]);setUniform4f(program,"u_bgColor",binaryColors[1]);render()}});elements.setColorPallet=document.getElementById("setColorPallet");elements.setColorPallet.addEventListener("change",function(e){if(!elements.gradientSelector)elements.gradientSelector=document.getElementById("gradientSelector");if(e.target.value=="Random"){elements.gradientSelector.gradient.randomPallet()}else{elements.gradientSelector.gradient.setPallet(pallets[e.target.selectedIndex].pallet)}render()});elements.orbitSize=document.getElementById("orbitSize");elements.orbitSize.addEventListener("change",function(e){orbitImageSize=e.target.value;setUniform1f(program,"u_orbitSize",orbitImageSize);render()});elements.orbitImage=document.getElementById("orbitImage");elements.fileLoader=document.getElementById("fileLoader");elements.fileLoader.addEventListener("change",function(e){if(!onServer){var URL=window.webkitURL||window.URL;var url=URL.createObjectURL(elements.fileLoader.files[0]);setOrbitImage(url)}else{ajaxFileUpload("?image_upload=true",elements.fileLoader.files[0],true,{onload:function(response){if(response.readyState===4){if(response.status===200){setOrbitImage("http://dijitalelefan.com/projects/fractalGL/"+response.responseText)}else{console.error(response.statusText)}}}})}})}function parseControls(){fractalParams={};fractalParams.binaryColors=binaryColors;if(orbitImage)fractalParams.orbitImage={width:orbitImage.width,height:orbitImage.height};fractalParams.fractals=[];for(var i=0;i<fractalCount;i++)fractalParams.fractals[i]=document.getElementById("fractal"+i).value;fractalParams.renderer=document.getElementById("renderer").value;setClass(elements.orbitImage,"hidden",fractalParams.renderer.substr(0,10)!="orbitImage");if(document.getElementById("julia").checked)fractalParams.julia=true;fractalParams.iterations=document.getElementById("iterations").value;var radios=document.getElementsByName("escape");for(var i=0,length=radios.length;i<length;i++){if(radios[i].checked){fractalParams.escapeType=radios[i].value;break}}if(iterShown)fractalParams.iterSkip=document.getElementById("iterSkip").value;fractalParams.antialiasing={type:document.getElementById("aaingSelect").options.selectedIndex};if(fractalParams.antialiasing.type>0){fractalParams.antialiasing.count=document.getElementById("aaingRange").value;if(fractalParams.antialiasing.type!=2)fractalParams.antialiasing.count=Math.ceil(Math.sqrt(fractalParams.antialiasing.count))}fractalParams.colorCycle=document.getElementById("colorCycle").checked;recompile()}function juliaControls(julia){var el=document.getElementById("juliaControls");setClass(el,"hidden",!julia)}function waveControls(wave){var el=document.getElementById("waveControls");setClass(el,"hidden",!wave)}function iterControls(siterSkip){var el=document.getElementById("iterControls");if(siterSkip>0&&!iterShown){el.className=el.className.substr(0,el.className.length-7);iterShown=true}else if(siterSkip==0&&iterShown){el.className+=" hidden";iterShown=false}}function uniformControls(uniforms){if(!("uniformControls"in elements)){elements.uniformControls=document.getElementById("uniformControls")}var el=elements.uniformControls;if(uniforms.length==0){el.innerHTML="            Display Parameters:<br />\n";setClass(el,"hidden",true)}else{setClass(el,"hidden",false);uniformElements=el.getElementsByTagName("input");var uniformNames=[];for(var i=0;i<uniformElements.length;i++){uniformNames[i]=uniformElements[i].getAttribute("name");if(!uniformNames[i]in uniforms)el.removeChild(uniformElements[i])}for(var i=0;i<uniforms.length;i++){if(uniformNames.indexOf(uniforms[i].name)==-1){var step="step"in uniforms[i]?uniforms[i].step:"any";var value="value"in uniforms[i]?'value="'+uniforms[i].value+'" ':"";el.innerHTML+="            <span>"+uniforms[i].title+":</span>\n"+'            <input type="range" step="'+step+'" class="myRange" id="uniform'+i+'" min="'+uniforms[i].min+'" max="'+uniforms[i].max+'" name="'+uniforms[i].name+'" '+value+"/>"}}for(var i=0;i<uniformElements.length;i++){uniformElements[i].addEventListener("input",function(e){setUniform1f(program,e.target.getAttribute("name"),e.target.value);render()},false)}uniformCount=uniforms.length}}function populateFractallist(fractalList){for(fractal in shaderDetails.fractals){var f=document.createElement("option");f.text=deCamel(fractal);f.value=fractal;fractalList.add(f)}}function openMenu(){document.getElementById("controls").className="expanded";document.getElementById("open-button").className+=" hidden"}function closeMenu(){document.getElementById("controls").className="";var el=document.getElementById("open-button");el.className=el.className.substr(0,el.className.length-7)}function setOrbitImage(url){if(orbitTexture==0){orbitTexture=gl.createTexture()}orbitImage=new Image;orbitImage.onload=function(){fractalParams.orbitImage={width:orbitImage.width,height:orbitImage.height};recompile()};orbitImage.src=url}(function(){function write(buffer,offs){for(var i=2;i<arguments.length;i++){for(var j=0;j<arguments[i].length;j++){buffer[offs++]=arguments[i].charAt(j)}}}function byte2(w){return String.fromCharCode(w>>8&255,w&255)}function byte4(w){return String.fromCharCode(w>>24&255,w>>16&255,w>>8&255,w&255)}function byte2lsb(w){return String.fromCharCode(w&255,w>>8&255)}window.PNGlib=function(width,height,depth){this.width=width;this.height=height;this.depth=depth;this.pix_size=height*(width+1);this.data_size=2+this.pix_size+5*Math.floor((65534+this.pix_size)/65535)+4;this.ihdr_offs=0;this.ihdr_size=4+4+13+4;this.plte_offs=this.ihdr_offs+this.ihdr_size;this.plte_size=4+4+3*depth+4;this.trns_offs=this.plte_offs+this.plte_size;this.trns_size=4+4+depth+4;this.idat_offs=this.trns_offs+this.trns_size;this.idat_size=4+4+this.data_size+4;this.iend_offs=this.idat_offs+this.idat_size;this.iend_size=4+4+4;this.buffer_size=this.iend_offs+this.iend_size;this.buffer=new Array;this.palette=new Object;this.pindex=0;var _crc32=new Array;for(var i=0;i<this.buffer_size;i++){this.buffer[i]="\x00"}write(this.buffer,this.ihdr_offs,byte4(this.ihdr_size-12),"IHDR",byte4(width),byte4(height),"\b");write(this.buffer,this.plte_offs,byte4(this.plte_size-12),"PLTE");write(this.buffer,this.trns_offs,byte4(this.trns_size-12),"tRNS");write(this.buffer,this.idat_offs,byte4(this.idat_size-12),"IDAT");write(this.buffer,this.iend_offs,byte4(this.iend_size-12),"IEND");var header=8+(7<<4)<<8|3<<6;header+=31-header%31;write(this.buffer,this.idat_offs+8,byte2(header));for(var i=0;(i<<16)-1<this.pix_size;i++){var size,bits;if(i+65535<this.pix_size){size=65535;bits="\x00"}else{size=this.pix_size-(i<<16)-i;bits=""}write(this.buffer,this.idat_offs+8+2+(i<<16)+(i<<2),bits,byte2lsb(size),byte2lsb(~size))}for(var i=0;i<256;i++){var c=i;for(var j=0;j<8;j++){if(c&1){c=-306674912^c>>1&2147483647}else{c=c>>1&2147483647}}_crc32[i]=c}this.index=function(x,y){var i=y*(this.width+1)+x+1;var j=this.idat_offs+8+2+5*Math.floor(i/65535+1)+i;return j};this.color=function(red,green,blue,alpha){alpha=alpha>=0?alpha:255;var color=((alpha<<8|red)<<8|green)<<8|blue;if(typeof this.palette[color]=="undefined"){if(this.pindex==this.depth)return"\x00";var ndx=this.plte_offs+8+3*this.pindex;this.buffer[ndx+0]=String.fromCharCode(red);this.buffer[ndx+1]=String.fromCharCode(green);this.buffer[ndx+2]=String.fromCharCode(blue);this.buffer[this.trns_offs+8+this.pindex]=String.fromCharCode(alpha);this.palette[color]=String.fromCharCode(this.pindex++)}return this.palette[color]};this.getBase64=function(){var s=this.getDump();var ch="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var c1,c2,c3,e1,e2,e3,e4;var l=s.length;var i=0;var r="";do{c1=s.charCodeAt(i);e1=c1>>2;c2=s.charCodeAt(i+1);e2=(c1&3)<<4|c2>>4;c3=s.charCodeAt(i+2);if(l<i+2){e3=64}else{e3=(c2&15)<<2|c3>>6}if(l<i+3){e4=64}else{e4=c3&63}r+=ch.charAt(e1)+ch.charAt(e2)+ch.charAt(e3)+ch.charAt(e4)}while((i+=3)<l);return r};this.getDump=function(){var BASE=65521;var NMAX=5552;var s1=1;var s2=0;var n=NMAX;for(var y=0;y<this.height;y++){for(var x=-1;x<this.width;x++){s1+=this.buffer[this.index(x,y)].charCodeAt(0);s2+=s1;if((n-=1)==0){s1%=BASE;s2%=BASE;n=NMAX}}}s1%=BASE;s2%=BASE;write(this.buffer,this.idat_offs+this.idat_size-8,byte4(s2<<16|s1));function crc32(png,offs,size){var crc=-1;for(var i=4;i<size-4;i+=1){crc=_crc32[(crc^png[offs+i].charCodeAt(0))&255]^crc>>8&16777215}write(png,offs+size-4,byte4(crc^-1))}crc32(this.buffer,this.ihdr_offs,this.ihdr_size);crc32(this.buffer,this.plte_offs,this.plte_size);crc32(this.buffer,this.trns_offs,this.trns_size);crc32(this.buffer,this.idat_offs,this.idat_size);crc32(this.buffer,this.iend_offs,this.iend_size);return"PNG\r\n\n"+this.buffer.join("")}}})();function initShaders(){uniformCache={};size=[window.innerWidth,window.innerHeight];if(zoom==0)zoom=4/size[1];size=[window.innerWidth,window.innerHeight];gl=canvas.getContext("experimental-webgl",{preserveDrawingBuffer:true});canvas.width=size[0];canvas.height=size[1];gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight);buffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),gl.STATIC_DRAW);shaderScript=document.getElementById("2d-vertex-shader");shaderSource=shaderScript.text;vertexShader=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(vertexShader,shaderSource);gl.compileShader(vertexShader);shaderScript=document.getElementById("2d-fragment-shader");shaderSource=makeShader(fractalParams).source;console.log(shaderSource);fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(fragmentShader,shaderSource);gl.compileShader(fragmentShader);program=gl.createProgram();gl.attachShader(program,vertexShader);gl.attachShader(program,fragmentShader);gl.linkProgram(program);gl.useProgram(program);texture=gl.createTexture();attachTexture();setUniform1f(program,"u_zoom",zoom);setUniform2f(program,"u_loc",loc[0],loc[1]);setUniform2f(program,"u_size",size[0],size[1]);setUniform1f(program,"u_wave_count",5);setUniform1f(program,"u_wave_phase",0);setUniform1f(program,"u_orbitSize",orbitImageSize);setUniform2f(program,"u_c",mLoc[0],mLoc[1]);setUniform4f(program,"u_fgColor",binaryColors[0]);setUniform4f(program,"u_bgColor",binaryColors[1]);render()}function recompile(){gl.detachShader(program,fragmentShader);gl.deleteShader(fragmentShader);shaderData=makeShader(fractalParams);juliaControls(shaderData.julia);waveControls(shaderData.wave);iterControls(shaderData.iterSkip);uniformControls(shaderData.uniforms);console.log(shaderData.source);fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(fragmentShader,shaderData.source);gl.compileShader(fragmentShader);gl.attachShader(program,fragmentShader);gl.linkProgram(program);gl.useProgram(program);uniformCache={};for(var i=0;i<uniformElements.length;i++){var name=uniformElements[i].getAttribute("name");var val=uniformElements[i].value;setUniform1f(program,name,val)}setUniform1f(program,"u_zoom",zoom);setUniform2f(program,"u_loc",loc[0],loc[1]);setUniform2f(program,"u_size",size[0],size[1]);setUniform1f(program,"u_wave_count",5);setUniform1f(program,"u_wave_phase",0);setUniform1f(program,"u_orbitSize",orbitImageSize);setUniform2f(program,"u_c",mLoc[0],mLoc[1]);attachTexture();setUniform4f(program,"u_fgColor",binaryColors[0]);setUniform4f(program,"u_bgColor",binaryColors[1]);if(orbitTexture!=0){gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,orbitTexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,orbitImage);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.uniform1i(gl.getUniformLocation(program,"u_orbitText"),1)}render()}function render(){gl.clearColor(1,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT);var positionLocation=gl.getAttribLocation(program,"a_position");gl.enableVertexAttribArray(positionLocation);gl.vertexAttribPointer(positionLocation,2,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,6);console.log("rendered??")}function attachTexture(){gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST);populateColorTexture(document.getElementById("gradientSelector").pallet);uniforms["pallet"]=document.getElementById("gradientSelector").pallet;gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.uniform1i(gl.getUniformLocation(program,"u_tex"),0)}function populateColorTexture(pallet){for(var i=0;i<256;i++){textureArray[4*i]=pallet[i].r;textureArray[4*i+1]=pallet[i].g;textureArray[4*i+2]=pallet[i].b;textureArray[4*i+3]=255}binaryColors=[[pallet[0].r/255,pallet[0].g/255,pallet[0].b/255,1],[pallet[255].r/255,pallet[255].g/255,pallet[255].b/255,1]];gl.activeTexture(gl.TEXTURE0);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,256,1,0,gl.RGBA,gl.UNSIGNED_BYTE,textureArray)}function getUniformCache(program,name){uniformCache[name]=gl.getUniformLocation(program,name)}function setUniform1f(program,name,value){if(!(name in uniformCache))getUniformCache(program,name);uniforms[name]=value;gl.uniform1f(uniformCache[name],value)}function setUniform2f(program,name,val1,val2){if(!(name in uniformCache))getUniformCache(program,name);uniforms[name]=[val1,val2];gl.uniform2f(uniformCache[name],val1,val2)}function setUniform4f(program,name,vec){if(!(name in uniformCache))getUniformCache(program,name);uniforms[name]=vec;gl.uniform4f(uniformCache[name],vec[0],vec[1],vec[2],vec[3])}function renderLarge(width,height,linkElement){var blockWidth=Math.ceil(width/size[0]),blockHeight=Math.ceil(height/size[1]);var blockCount=Math.max(blockWidth,blockHeight);width=blockCount*canvas.width;height=blockCount*canvas.height;var saveZoom=zoom;var upperLeft={x:-size[0]*zoom/2+loc[0],y:-size[1]*zoom/2+loc[1]};var fractalSize={x:size[0]*zoom,y:size[1]*zoom};setUniform1f(program,"u_zoom",zoom/blockCount);console.log(loc);var blockSize={x:fractalSize.x/blockCount,y:fractalSize.y/blockCount};var bigLoc={x:0,y:0};var png=new PNGlib(width,height,256);var buf=new Uint8Array(gl.canvas.width*gl.canvas.height*4);for(var x=0;x<blockCount;x++){bigLoc.x=upperLeft.x+(x+.5)*blockSize.x;for(var y=0;y<blockCount;y++){bigLoc.y=upperLeft.y+(y+.5)*blockSize.y;setUniform2f(program,"u_loc",bigLoc.x,bigLoc.y);render();gl.readPixels(0,0,gl.canvas.width,gl.canvas.height,gl.RGBA,gl.UNSIGNED_BYTE,buf);for(var nX=0;nX<gl.canvas.width&&nX+x<width;nX++){for(var nY=0;nY<gl.canvas.height&&nY+y<height;nY++){var index=4*(nX+nY*gl.canvas.width);png.buffer[png.index(nX+x*gl.canvas.width,nY+y*gl.canvas.height)]=png.color(buf[index],buf[index+1],buf[index+2])}}}}downloadURI("data:image/png;base64,"+png.getBase64(),"fractalLarge.png",linkElement);bigLoc.x=upperLeft.x+(blockCount/2+.5)*blockSize.x;bigLoc.y=upperLeft.y+(blockCount/2+.5)*blockSize.y;console.log(bigLoc.x,bigLoc.y);setUniform2f(program,"u_loc",loc[0],loc[1]);setUniform1f(program,"u_zoom",zoom);setTimeout(render,1e3)}function generateLink(el){var url=exportFractal();modalWindow("To share this fractal, you can simply share this unfortunately lengthy url:<br />"+'<a href="http://dijitalelefan.com/projects/fractalGL/?id='+url+'" title="Cool Fractal!">'+"http://dijitalelefan.com/projects/fractalGL/?id="+url+"</a>",el)}function exportFractal(){var data={fractalParams:fractalParams,zoom:zoom,loc:loc,mLoc:mLoc,pallet:elements.gradientSelector.gradient.getPalletData()};var idString=Date.now().toString(36)+randomString(5);ajax("",{id:idString,data:JSON.stringify(data),api_request:"save_fractal_data"});return idString}function loadFractal(){var dataElem=document.getElementById("fractalData");if(dataElem.getAttribute("preset")=="true"){try{var dataString=dataElem.getAttribute("json");var data=JSON.parse(dataString);fractalParams=data.fractalParams;juliaTracking=false;zoom=data.zoom;loc=data.loc;mLoc=data.mLoc;document.getElementById("gradientSelector").gradient.setPallet(data.pallet);recompile()}catch(err){console.log("an error occured! Oops",err)}}}function printPallet(){document.getElementById("gradientSelector").gradient.printPallet()}var gradients=[];(function(){window.addEventListener("load",function(){var ins=document.getElementsByTagName("input");for(var i=0;i<ins.length;i++){if(ins[i].getAttribute("type")=="gradient"){new GradientInput(ins[i])}}});function triggerEvent(object,eventName,options){var event;if(document.createEvent){event=document.createEvent("HTMLEvents");event.initEvent(eventName,true,true)}else{event=document.createEventObject();event.eventType=eventName}event.eventName=eventName;if(options){for(key in options){event[key]=options[key]}}if(document.createEvent){object.dispatchEvent(event)}else{object.fireEvent("on"+event.eventType,event)}}function lerpColor(col1,col2,s){return{r:Math.round(col1.r*(1-s)+col2.r*s),g:Math.round(col1.g*(1-s)+col2.g*s),b:Math.round(col1.b*(1-s)+col2.b*s)}}function color(grey){return{r:grey,g:grey,b:grey}}function color3(red,green,blue){return{r:red,g:green,b:blue}}function randomColor(){return color3(Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256))}function invert(color){return{r:255-color.r,g:255-color.g,b:255-color.b}}function getRGB(col){return"rgb("+col.r+", "+col.g+", "+col.b+")"}function GradientMarker(ctx,width,height,pallet,radius,params){this.radius=radius;this.width=width;this.heigth=height;this.ctx=ctx;this.color=params.color?params.color:randomColor();this.position="position"in params?params.position:Math.random();this.coords={cx:this.position*width+3*this.radius,cy:this.radius,py:0};this.coords.py=this.coords.cy+this.radius*Math.sqrt(2);this.locked=params.locked?true:false;this.active=false;this.pallet=pallet;this.draw=function(selected){this.ctx.beginPath();this.ctx.moveTo(this.coords.cx,this.coords.py);this.ctx.arc(this.coords.cx,this.coords.cy,this.radius,3/4*Math.PI,1/4*Math.PI,false);this.ctx.lineTo(this.coords.cx,this.coords.py);this.ctx.fillStyle=selected?"#DDD":"#FFF";this.ctx.fill();this.ctx.lineWidth=2;this.ctx.strokeStyle="#555";this.ctx.lineCap="round";this.ctx.stroke();this.ctx.beginPath();this.ctx.arc(this.coords.cx,this.coords.cy,this.radius*2/3,0,2*Math.PI,false);this.ctx.fillStyle=getRGB(this.color);this.ctx.fill();this.ctx.lineWidth=2;this.ctx.strokeStyle="#555";this.ctx.lineCap="round";this.ctx.stroke()};this.setPosition=function(pos){this.position=pos;this.coords={cx:this.position*width+3*this.radius,cy:this.radius,py:0};this.coords.py=this.coords.cy+this.radius*Math.sqrt(2)}}function insertAfter(elementToInsert,element){element.parentElement.insertBefore(elementToInsert,element.nextSibling)}function getMousePos(_canvas,evt){var rect=_canvas.getBoundingClientRect();return{x:evt.clientX-rect.left,y:evt.clientY-rect.top}}Array.prototype.swap=function(x,y){var b=this[x];this[x]=this[y];this[y]=b;return this};function GradientInput(element){var _self=this;var offset=10;this.offset=10;if(!(this.width=element.getAttribute("width"))){if(!element.style.width){element.style.width="276px"}this.width=element.style.width.substr(0,element.style.width.length-2)}this.width=parseInt(this.width)-offset*6;if(!(this.height=element.getAttribute("height"))){if(!element.style.height){element.style.height="64px"}this.height=element.style.height.substr(0,element.style.width.length-2)}this.height=parseInt(this.height)-offset*2;this.lineColor=element.style.color?element.style.color:"#000";this.depth=element.getAttribute("depth");if(!this.depth)this.depth=256;else this.depth=parseInt(this.depth);this.element=element;this.pallet=[];this.colors=[];element.style.display="none";this.canvas=document.createElement("CANVAS");this.canvas.setAttribute("width",this.width+6*offset);this.canvas.setAttribute("height",this.height+2*offset);this.canvas.style.display="block";insertAfter(this.canvas,element);element.gradient=this;this.ctx=this.canvas.getContext("2d");this.ctx.font="12px Arial";this.colorCanvas=document.createElement("CANVAS");this.colorCanvas.setAttribute("width",this.width+6*offset);this.colorCanvas.setAttribute("height",this.width+2*offset);insertAfter(this.colorCanvas,this.canvas);this.ctx2=this.colorCanvas.getContext("2d");this.markers=[new GradientMarker(this.ctx,this.width,this.height,this.pallet,offset,{position:0,locked:true}),new GradientMarker(this.ctx,this.width,this.height,this.pallet,offset,{position:1,locked:true})];this.activeMarker=1;this.markerSelected=false;this.colorSwatch=this.ctx2.createImageData(this.width,this.width);this.active=false;this.mouseOver=0;this.m={};var i=0;this.editMarkerSort=function(){var p1=this.markers[this.activeMarker].position;while(1){if(this.activeMarker>0&&this.markers[this.activeMarker-1].position>p1){this.markers.swap(this.activeMarker,this.activeMarker-1);this.activeMarker--}else if(this.activeMarker<this.markers.length-1&&this.markers[this.activeMarker+1].position<p1){this.markers.swap(this.activeMarker,this.activeMarker+1);this.activeMarker++}else{break}}};this.clearBar=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)};this.drawBar=function(){for(var x=0;x<this.width;x++){var col=this.pallet[Math.floor(this.depth*x/this.width)];this.ctx.beginPath();this.ctx.moveTo(x+3*offset,(1+Math.sqrt(2))*offset);this.ctx.lineTo(x+3*offset,this.height);this.ctx.strokeStyle=getRGB(col);this.ctx.stroke()}var my=((1+Math.sqrt(2))*offset+this.height)/2;this.ctx.strokeStyle=this.lineColor;if(this.markers.length>2){this.ctx.beginPath();this.ctx.lineWidth=this.mouseOver==1?5:2;this.ctx.moveTo(5,my-7.5);this.ctx.lineTo(20,my+7.5);this.ctx.moveTo(20,my-7.5);this.ctx.lineTo(5,my+7.5);this.ctx.stroke()}this.ctx.beginPath();this.ctx.lineWidth=this.mouseOver==2?5:2;this.ctx.moveTo(this.width+6*this.offset-3,my);this.ctx.lineTo(this.width+6*this.offset-23,my);this.ctx.moveTo(this.width+6*this.offset-12.5,my-10);this.ctx.lineTo(this.width+6*this.offset-12.5,my+10);this.ctx.stroke();this.ctx.lineWidth=1;if(this.active){this.drawMarkers()}};this.drawColorSelector=function(){var col=this.markers[this.activeMarker].color;this.ctx2.fillStyle=getRGB(col);this.ctx2.fillRect(0,0,this.colorCanvas.width,this.colorCanvas.height);var blue=col.b;for(var x=0;x<this.width;x++){for(var y=0;y<this.width;y++){var index=4*(x+y*this.width);this.colorSwatch.data[index]=Math.floor(x*256/this.width);this.colorSwatch.data[index+1]=Math.floor(y*256/this.width);this.colorSwatch.data[index+2]=blue;this.colorSwatch.data[index+3]=255}}for(var y=0;y<this.width;y++){this.ctx2.beginPath();this.ctx2.moveTo(this.width+this.offset*2,this.offset+y);this.ctx2.lineTo(this.width+this.offset*5,this.offset+y);this.ctx2.strokeStyle=getRGB(color3(col.r,col.g,Math.floor(y*256/this.width)));this.ctx2.stroke()}this.ctx2.putImageData(this.colorSwatch,this.offset,this.offset);var c={x:col.r*this.width/256+this.offset,y:col.g*this.width/256+this.offset};this.ctx2.beginPath();this.ctx2.moveTo(c.x,this.offset);this.ctx2.lineTo(c.x,c.y-this.offset/2);this.ctx2.moveTo(c.x,this.colorCanvas.height-this.offset);this.ctx2.lineTo(c.x,c.y+this.offset/2);this.ctx2.moveTo(this.offset,c.y);this.ctx2.lineTo(c.x-this.offset/2,c.y);this.ctx2.moveTo(c.x+this.offset/2,c.y);this.ctx2.lineTo(this.colorCanvas.height-this.offset,c.y);this.ctx2.moveTo(this.width+this.offset*2,this.offset+col.b*this.width/256);this.ctx2.lineTo(this.width+this.offset*5,this.offset+col.b*this.width/256);this.ctx2.strokeStyle=getRGB(invert(col));this.ctx2.stroke();this.ctx2.strokeRect(c.x-this.offset/2,c.y-this.offset/2,this.offset,this.offset);this.ctx2.strokeRect(this.width+this.offset*2,this.offset,this.offset*3,this.width)};this.drawMarkers=function(){for(var i=0;i<this.markers.length;i++){this.markers[i].draw(i==this.activeMarker)}};this.draw=function(){this.drawBar();if(this.active){this.drawColorSelector()}};this.colorMouseDown=function(e){var col=this.markers[this.activeMarker].color;var m=getMousePos(this.colorCanvas,e);if(m.x>this.offset&&m.x<this.offset+this.width&&m.y>this.offset&&m.y<this.offset+this.width){this.markers[this.activeMarker].color=color3(Math.floor((m.x-this.offset)*256/this.width),Math.floor((m.y-this.offset)*256/this.width),col.b);this.generatePallet();this.draw()}else if(m.x>this.width+this.offset*2&&m.x<this.width+this.offset*5&&m.y>this.offset&&m.y<this.offset+this.width){this.markers[this.activeMarker].color=color3(col.r,col.g,Math.floor((m.y-this.offset)*256/this.width));this.generatePallet();this.draw()}};this.mainMouseDown=function(e){if(this.markers.length>2&&this.m.x>5&&this.m.x<20&&this.m.y>this.offset&&this.m.y<this.height){
if(this.markers[this.activeMarker].locked){this.markers.splice(1,1)}else{this.markers.splice(this.activeMarker,1);this.activeMarker--}this.generatePallet();this.draw()}else if(this.m.x>this.width+6*this.offset-23&&this.m.x<this.width+6*this.offset-3&&this.m.y>this.offset&&this.m.y<this.height){this.markers.push(new GradientMarker(this.ctx,this.width,this.height,this.pallet,offset,{}));this.activeMarker=this.markers.length-1;this.editMarkerSort();this.generatePallet();this.draw()}else{if(!this.active){this.active=true;this.colorCanvas.style.display="block";this.draw()}else{var m=getMousePos(this.canvas,e);if(m.y<(1+Math.sqrt(2))*this.offset){for(var i=0;i<this.markers.length;i++){if(Math.abs(m.x-this.markers[i].coords.cx)<this.offset&&Math.abs(m.y-this.markers[i].coords.cy)<this.offset){this.activeMarker=i;this.markerSelected=true;this.draw();break}}}}}};this.mainMouseMoved=function(e){if(this.texting){this.clearBar();this.drawBar();if(this.active){this.drawMarkers()}this.texting=false}this.m=getMousePos(this.canvas,e);if(e.buttons>0&&this.markerSelected&&!this.markers[this.activeMarker].locked){this.clearBar();this.markers[this.activeMarker].setPosition(Math.min(1,Math.max(0,(this.m.x-3*this.offset)/this.width)));this.editMarkerSort();this.generatePallet();this.drawBar();this.drawMarkers()}else{if(this.markers.length>2&&this.m.x>5&&this.m.x<20&&this.m.y>this.offset&&this.m.y<this.height){if(this.mouseOver!=1){this.mouseOver=1;this.drawBar();this.dra}setTimeout(function(){if(_self.m.x>5&&_self.m.x<20&&_self.m.y>_self.offset&&_self.m.y<_self.height){var txt="Remove";var w=_self.ctx.measureText(txt).width;_self.ctx.fillStyle="#fff";_self.ctx.fillRect(_self.m.x,_self.m.y-14,w+4,14);_self.ctx.strokeStyle="#000";_self.ctx.lineWidth=1;_self.ctx.strokeRect(_self.m.x,_self.m.y-14,w+4,14);_self.ctx.fillStyle="#000";_self.ctx.fillText(txt,_self.m.x+2,_self.m.y-2);_self.texting=true}},600)}else if(this.m.x>this.width+6*this.offset-23&&this.m.x<this.width+6*this.offset-3&&this.m.y>this.offset&&this.m.y<this.height){if(this.mouseOver!=2){this.mouseOver=2;this.drawBar()}setTimeout(function(){if(_self.m.x>_self.width+6*_self.offset-23&&_self.m.x<_self.width+6*_self.offset-3&&_self.m.y>_self.offset&&_self.m.y<_self.height){var txt="Add";var w=_self.ctx.measureText(txt).width;_self.ctx.fillStyle="#fff";_self.ctx.fillRect(_self.m.x-w-4,_self.m.y-14,w+4,14);_self.ctx.strokeStyle="#000";_self.ctx.strokeRect(_self.m.x-w-4,_self.m.y-14,w+4,14);_self.ctx.fillStyle="#000";_self.ctx.fillText(txt,_self.m.x-w-2,_self.m.y-2);this.texting=true}},600)}else if(this.mouseOver!=0){this.mouseOver=0;this.clearBar();this.drawBar()}}};this.doubleClick=function(){if(this.active){this.colorCanvas.style.display="none";this.active=false;this.clearBar();this.drawBar()}else{this.active=true;this.colorCanvas.style.display="block";this.draw()}};this.generatePallet=function(){var i=0;for(var x=0;x<this.depth;x++){if(x/this.depth>=this.markers[i+1].position)i++;var map=(x/this.depth-this.markers[i].position)/(this.markers[i+1].position-this.markers[i].position);this.pallet[x]=lerpColor(this.markers[i].color,this.markers[i+1].color,map)}this.element.pallet=this.pallet;triggerEvent(this.element,"change",{pallet:this.pallet})};this.setPallet=function(markerData){this.markers=[];for(var i=0;i<markerData.length;i++){this.markers[i]=new GradientMarker(this.ctx,this.width,this.height,this.pallet,this.offset,{position:i==0?0:i==markerData.length-1?1:markerData[i].position,locked:i==0||i==markerData.length-1,color:markerData[i].color})}this.generatePallet();this.draw()};this.randomPallet=function(){this.setPallet([{color:randomColor()},{color:randomColor()}])};this.printPallet=function(){var data=[];for(var i=0;i<this.markers.length;i++){data[i]={color:this.markers[i].color,position:this.markers[i].position}}console.log(JSON.stringify(data))};this.getPalletData=function(){var data=[];for(var i=0;i<this.markers.length;i++){data[i]={color:this.markers[i].color,position:this.markers[i].position}}return data};this.generatePallet();this.draw();this.colorCanvas.addEventListener("mousedown",function(e){_self.colorMouseDown(e)});this.colorCanvas.addEventListener("mousemove",function(e){if(e.buttons>0){_self.colorMouseDown(e)}});this.canvas.addEventListener("mousedown",function(e){_self.mainMouseDown(e)});this.canvas.addEventListener("mousemove",function(e){_self.mainMouseMoved(e)});this.canvas.addEventListener("dblclick",function(e){_self.doubleClick()});this.canvas.addEventListener("blur",function(e){_self.markerSelected=false});this.canvas.addEventListener("mouseup",function(e){_self.markerSelected=false});this.colorCanvas.addEventListener("dblclick",function(e){_self.doubleClick()});gradients.push(this)}})();function init(){onServer=document.getElementById("serverless")?false:true;canvas=document.getElementById("glscreen");initInput(canvas);fractalParams={julia:false,renderer:"logarithmicSmoothing",fractals:["mandelbrot"],iterations:50,binaryColors:binaryColors};initShaders();if(window.location.hash.length>0){loadFractal();closeMenu()}}window.onload=init;window.onresize=initShaders;function triggerEvent(object,eventName){var event;if(document.createEvent){event=document.createEvent("HTMLEvents");event.initEvent(eventName,true,true)}else{event=document.createEventObject();event.eventType=eventName}event.eventName=eventName;if(document.createEvent){object.dispatchEvent(event)}else{object.fireEvent("on"+event.eventType,event)}}function toggleClass(elem,className){if(typeof elem.className=="undefined"){console.log("hey...",elem.className);elem.className=""}var index=elem.className.indexOf(className);if(index==-1)elem.className+=" "+className;else elem.className=elem.className.substr(0,index)+elem.className.substr(index+className.length+1)}function setClass(elem,className,toggle){if(typeof elem.className=="undefined"){console.log("hey...",elem);elem.className=""}var index=elem.className.indexOf(className);if(index==-1&&toggle)elem.className+=" "+className;else if(index>-1&&!toggle)elem.className=elem.className.substr(0,index)+elem.className.substr(index+className.length+1)}function customizeSelect(select){this.select=select;this.options=select.options;this.width=select.offsetWidth-4;this.height=21;this.newElementInner='    <span class="upgradedSelected"><span class="upgradedSelectedText">'+this.options[this.options.selectedIndex].text+'</span><i class="fa fa-caret-square-o-down upgradedSelectButton" style="line-height:'+this.height+'px;"></i></span>\n'+'    <ul class="upgradedSelectList hidden">\n';for(var i=0;i<this.options.length;i++){this.newElementInner+='        <li index="'+i+'">'+this.options[i].text+"</li>\n"}this.newElementInner+="    </ul>\n";this.el=document.createElement("span");this.el.setAttribute("tabindex","0");var sId=select.getAttribute("id");if(sId.length>0)this.el.setAttribute("id",sId+"_customSelect");this.el.className="upgradedSelect";this.el.innerHTML=this.newElementInner;this.el.setAttribute("style","width:"+this.width+"px; line-height:"+this.height+"px;");select.parentElement.insertBefore(this.el,select.nextSibling);this.activeElement=this.el.getElementsByClassName("upgradedSelected")[0];this.newOptions=this.el.getElementsByClassName("upgradedSelectList")[0];this.activeElement.setAttribute("style","width:"+this.width+"px;height:"+this.height+"px; line-height:"+this.height+"px;");this.newOptions.expanded=false;this.mouseDown=function(e){toggleClass(this.newOptions,"hidden")};this.mouseUp=function(e){console.log("mouseup!",e.target.getAttribute("index"));var index=e.target.getAttribute("index");if(index!=null){this.select.selectedIndex=index;triggerEvent(this.select,"change");this.activeElement.firstChild.innerHTML=e.target.innerHTML;setClass(this.newOptions,"hidden",true)}};this.blur=function(){setClass(this.newOptions,"hidden",true)};var _self=this;this.activeElement.addEventListener("mousedown",function(e){_self.mouseDown(e)});this.newOptions.addEventListener("mouseup",function(e){console.log("hiiiiii?");_self.mouseUp(e)});select.setAttribute("style","display:none")}window.addEventListener("load",function(){var elements=document.getElementsByClassName("mySelect");console.log(elements);for(var i=0;i<elements.length;i++){var e=new customizeSelect(elements[i])}});
